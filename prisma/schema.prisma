// This schema mirrors the existing GoFast backend schema
// We only include the models we need for training

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Athlete {
  id String @id @default(cuid())

  // Auth
  firebaseId String  @unique
  email      String?

  // Company Link (Single-tenant) - REQUIRED
  companyId String
  company   GoFastCompany @relation(fields: [companyId], references: [id])

  // Universal profile
  firstName    String?
  lastName     String?
  gofastHandle String?   @unique
  photoURL     String?
  phoneNumber  String?
  birthday     DateTime?
  gender       String?
  city         String?
  state        String?
  primarySport String?
  bio          String?
  instagram    String?

  // Profile Identity (can be updated)
  fiveKPace String? // mm:ss format - THE SOURCE OF TRUTH for CURRENT 5K pace

  // Legacy training fields (deprecated, keep for migration)
  myCurrentPace       String?
  myWeeklyMileage     Int?
  myTrainingGoal      String?
  myTrainingStartDate DateTime?
  myTargetRace        String?
  preferredDistance   String?
  myPaceRange         String?
  timePreference      String?
  myRunningGoals      String?

  // Garmin PKCE Integration
  garmin_user_id          String?   @unique
  garmin_access_token     String?
  garmin_refresh_token    String?
  garmin_expires_in       Int?
  garmin_scope            String?
  garmin_connected_at     DateTime?
  garmin_last_sync_at     DateTime?
  garmin_is_connected     Boolean   @default(false)
  garmin_disconnected_at  DateTime?
  garmin_permissions      Json?
  garmin_user_profile     Json?
  garmin_user_sleep       Json?
  garmin_user_preferences Json?

  // Strava (future)
  strava_id            Int?    @unique
  strava_access_token  String?
  strava_refresh_token String?
  strava_expires_at    Int?

  // System fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trainingPlans        TrainingPlan[]
  athleteTrainingPlans AthleteTrainingPlan[] // Junction table for multiple plans
  executedDays         TrainingDayExecuted[]
  activities           AthleteActivity[]
}

model AthleteActivity {
  id               String @id @default(cuid())
  athleteId        String
  sourceActivityId String @unique
  source           String @default("garmin")

  activityType     String?
  activityName     String?
  startTime        DateTime?
  duration         Int?
  distance         Float?
  calories         Int?
  averageSpeed     Float?
  averageHeartRate Int?
  maxHeartRate     Int?
  elevationGain    Float?
  steps            Int?

  // Location + Polyline
  startLatitude   Float?
  startLongitude  Float?
  endLatitude     Float?
  endLongitude    Float?
  summaryPolyline String?

  summaryData Json?
  detailData  Json?
  hydratedAt  DateTime?

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("athlete_activities")
}

// Race - Global catalogue of races (registry pattern)
// Registry pattern: One race (Boston Marathon 2025) exists once, many TrainingPlans can reference it
model Race {
  id        String   @id @default(cuid())
  name      String
  raceType  String   // "marathon", "half", "5k", "10k", "10m" - enum from config
  miles     Float    // Derived from raceType using config/race-types.ts
  date      DateTime
  city      String?
  state     String?
  country   String?
  createdBy String? // Optional: athleteId who first created it (for tracking, not ownership)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - Direct 1-to-many with TrainingPlan
  trainingPlans TrainingPlan[]

  // Unique constraint: prevent duplicate races (same name + date)
  @@unique([name, date])
  @@map("race_registry")
}

// Junction table: Athlete <-> TrainingPlan (many-to-many)
// For future "My Training Plans" selection screen. MVP1: only created when plan is generated.
model AthleteTrainingPlan {
  id             String   @id @default(cuid())
  athleteId      String
  trainingPlanId String
  assignedAt     DateTime @default(now())

  // Relations
  athlete      Athlete      @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  trainingPlan TrainingPlan @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)

  @@unique([athleteId, trainingPlanId])
  @@map("athlete_training_plans")
}

model TrainingPlan {
  id        String @id @default(cuid())
  athleteId String // Original creator/owner
  raceId    String? // Direct FK to Race (many TrainingPlans can reference same Race)

  // PLAN IDENTITY
  name String // Renamed from trainingPlanName

  // CYCLE-LEVEL GOALS
  goalTime String? // Renamed from trainingPlanGoalTime, e.g., "3:30:00" for marathon
  goalPace5K String? // DEPRECATED: Keep for backward compatibility, use goalRacePace instead
  goalRacePace Int? // Goal race pace in seconds per mile (derived from goalTime + race.miles)
  predictedRacePace Int? // Predicted race pace in seconds per mile (derived from athlete.fiveKPace + race adjustments)

  // BASELINE METRICS (collected during setup, used for gradual progression)
  current5KPace String? // Current 5K pace in mm:ss format (baseline fitness)
  currentWeeklyMileage Int? // Current weekly mileage (baseline volume)

  // PLAN STRUCTURE
  startDate DateTime // Renamed from trainingPlanStartDate
  totalWeeks Int // Renamed from trainingPlanTotalWeeks

  // STATUS
  status String @default("draft")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  athlete              Athlete               @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  race                 Race?                  @relation(fields: [raceId], references: [id], onDelete: SetNull)
  athleteTrainingPlans AthleteTrainingPlan[] // Junction table entries
  phases               TrainingPlanPhase[]
  weeks                TrainingPlanWeek[]
  days                 TrainingPlanDay[]
  // Note: No @@map - uses Prisma default PascalCase table name "TrainingPlan" to match gofastapp-mvp

  // Indexes for fast lookups
  @@index([athleteId, status]) // Fast lookup of active plans by athlete
  @@index([raceId]) // Fast lookup of all plans for a race
}

// Phase: Base / Build / Peak / Taper
model TrainingPlanPhase {
  id     String @id @default(cuid())
  planId String

  // Phase Identity
  name String // "base" | "build" | "peak" | "taper"
  weekCount Int // How many weeks in this phase
  totalMiles Float? // Sum of miles across all weeks in this phase (computed optional)

  // Relations
  plan  TrainingPlan      @relation(fields: [planId], references: [id], onDelete: Cascade)
  weeks TrainingPlanWeek[]
  days  TrainingPlanDay[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, name]) // One phase per name per plan (can't have duplicate "base" phases)
  @@map("training_plan_phases")
}

// Week: Belongs to both plan and phase
model TrainingPlanWeek {
  id      String @id @default(cuid())
  planId  String
  phaseId String

  // Week Identity
  weekNumber Int // Global week number (1, 2, 3...) within the entire plan
  miles      Float? // Computed from days

  // Relations
  plan  TrainingPlan      @relation(fields: [planId], references: [id], onDelete: Cascade)
  phase TrainingPlanPhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  days  TrainingPlanDay[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, weekNumber]) // One week per plan per week number
  @@map("training_plan_weeks")
}

// Day: Belongs to plan, phase, and week
// DATE-DRIVEN MODEL: date is authoritative, dayOfWeek is derived from date
model TrainingPlanDay {
  id      String @id @default(cuid())
  planId  String
  phaseId String
  weekId  String

  // Day Identity (DATE-DRIVEN)
  date      DateTime // Actual calendar date (authoritative)
  dayOfWeek Int // 1-7 (1=Monday, 7=Sunday) - computed from date

  // Structured Workout (Lap arrays)
  warmup  Json // Lap[]
  workout Json // Lap[]
  cooldown Json // Lap[]

  notes String?

  // Relations
  plan  TrainingPlan      @relation(fields: [planId], references: [id], onDelete: Cascade)
  phase TrainingPlanPhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  week  TrainingPlanWeek  @relation(fields: [weekId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, date]) // One day per plan per date (date-driven identity)
  @@index([date]) // Fast date lookups
  @@index([planId, date]) // Fast plan + date lookups
  @@map("training_plan_days")
}

model TrainingDayExecuted {
  id        String @id @default(cuid())
  athleteId String

  // THE LINK - shell container for AthleteActivity
  activityId String? @unique

  // Optional metadata
  weekIndex Int
  dayIndex  Int
  date      DateTime

  // Snapshot/computed fields
  plannedData Json?
  analysis    Json?
  feedback    Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@map("training_days_executed")
}

//////////////////////////////////////////////////////////
//  GOFAST COMPANY (SINGLE-TENANT CONTAINER)
//////////////////////////////////////////////////////////

model GoFastCompany {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  address   String?
  city      String?
  state     String?
  zip       String?
  domain    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athletes Athlete[]

  @@map("go_fast_companies")
}
