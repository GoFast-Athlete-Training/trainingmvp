// This schema mirrors the existing GoFast backend schema
// We only include the models we need for training

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Athlete {
  id         String @id @default(cuid())
  firebaseId String @unique

  // Canonical Identity (can be updated)
  canonicalFiveKPace  String? // mm:ss format
  preferredRunDays    Int[]   // e.g. [1,3,5] where 1=Monday, 7=Sunday (empty array if not set)

  // Legacy fields (deprecated, keep for migration)
  myCurrentPace       String?
  myWeeklyMileage     Int?
  myTrainingGoal      String?
  myTargetRace        String?
  myTrainingStartDate DateTime?

  // System fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trainingPlans              TrainingPlan[]
  plannedDays                TrainingDayPlanned[]
  executedDays               TrainingDayExecuted[]
  activities                 AthleteActivity[]
  trainingPlanFiveKPaces     TrainingPlanFiveKPace[]
  trainingPlanPreferredDays  TrainingPlanPreferredDays[]

  @@map("athletes")
}

model AthleteActivity {
  id        String @id @default(cuid())
  athleteId String

  // Source Information
  sourceActivityId String @unique
  source           String @default("garmin")

  // Core Activity Data
  activityType String?
  activityName String?
  startTime    DateTime?
  duration     Int?
  distance     Float?
  averageSpeed Float?
  calories     Int?

  // Performance Metrics
  averageHeartRate Int?
  maxHeartRate     Int?
  elevationGain    Float?

  // Timestamps
  syncedAt      DateTime @default(now())
  lastUpdatedAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@map("athlete_activities")
}

// Legacy Race model - deprecated, use RaceRegistry instead
model Race {
  id String @id @default(cuid())

  // Race Event Details
  raceName      String
  raceType      String
  raceDate      DateTime
  location      String?
  distanceMiles Float

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations (deprecated - no new plans should use this)
  // trainingPlans TrainingPlan[] // Removed - use RaceRegistry instead

  @@map("races")
}

// Race Registry - Global catalogue of races
model RaceRegistry {
  id        String   @id @default(cuid())
  name      String
  distance  String   // "marathon", "half", "5k", "10k", etc.
  date      DateTime
  city      String?
  state     String?
  country   String?
  createdBy String   // athleteId who created it
  isGlobal  Boolean  @default(false) // true = available to all users

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trainingPlans TrainingPlan[]

  @@map("race_registry")
}

model TrainingPlan {
  id        String @id @default(cuid())
  athleteId String
  raceRegistryId String // References RaceRegistry

  // PLAN IDENTITY
  trainingPlanName String

  // CYCLE-LEVEL GOALS
  trainingPlanGoalTime String?

  // PLAN STRUCTURE
  trainingPlanStartDate  DateTime
  trainingPlanTotalWeeks Int

  // STATUS
  status String @default("draft")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  athlete                Athlete                 @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  raceRegistry           RaceRegistry            @relation(fields: [raceRegistryId], references: [id], onDelete: Cascade)
  plannedDays            TrainingDayPlanned[]
  trainingPlanFiveKPace  TrainingPlanFiveKPace?
  trainingPlanPreferredDays TrainingPlanPreferredDays?

  @@map("training_plans")
}

model TrainingDayPlanned {
  id             String  @id @default(cuid())
  trainingPlanId String
  athleteId      String

  // Day Identification
  weekIndex Int
  dayIndex  Int  // MUST be 1-7 (1=Monday, 7=Sunday)
  phase     String // "base", "build", "peak", "taper"

  // Computed date (calculated by backend, not from AI)
  date      DateTime

  // PLANNED WORKOUT (atomic element)
  plannedData Json

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trainingPlan TrainingPlan @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)
  athlete      Athlete      @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([trainingPlanId, weekIndex, dayIndex])
  @@map("training_days_planned")
}

// Plan-specific snapshot: 5K pace at time of plan creation
model TrainingPlanFiveKPace {
  id            String @id @default(cuid())
  trainingPlanId String
  athleteId      String
  fiveKPace      String // mm:ss format

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trainingPlan TrainingPlan @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)
  athlete      Athlete      @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([trainingPlanId])
  @@map("training_plan_five_k_pace")
}

// Plan-specific snapshot: Preferred run days at time of plan creation
model TrainingPlanPreferredDays {
  id            String @id @default(cuid())
  trainingPlanId String
  athleteId      String
  preferredDays  Int[] // e.g. [1,3,5] where 1=Monday, 7=Sunday

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trainingPlan TrainingPlan @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)
  athlete      Athlete      @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([trainingPlanId])
  @@map("training_plan_preferred_days")
}

model TrainingDayExecuted {
  id        String @id @default(cuid())
  athleteId String

  // THE LINK - shell container for AthleteActivity
  activityId String? @unique

  // Optional metadata
  weekIndex Int
  dayIndex  Int
  date      DateTime

  // Snapshot/computed fields
  plannedData Json?
  analysis    Json?
  feedback    Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@map("training_days_executed")
}

